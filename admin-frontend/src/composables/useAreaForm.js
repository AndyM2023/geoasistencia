import { ref } from 'vue'
import areaService from '../services/areaService'
import { useNotifications } from './useNotifications'

export default function useAreaForm() {
  const { showSuccess, showError, showWarning, showInfo } = useNotifications()
  
  const showDialog = ref(false)
  const saving = ref(false)
  const editingArea = ref(null)
  const areaToDelete = ref(null)
  const showDeleteDialog = ref(false)
  const deleting = ref(false)
  
  const areaForm = ref({
    name: '',
    description: '',
    latitude: '',
    longitude: '',
    radius: 200,
    status: 'active'  // CR√çTICO: Incluir status por defecto
  })
  
  // Funci√≥n para formatear coordenadas (mostrar solo primeros 10 caracteres)
  const formatCoordinate = (coordinate) => {
    if (!coordinate) return '-'
    const coordStr = coordinate.toString()
    return coordStr.length > 10 ? coordStr.substring(0, 10) + '...' : coordStr
  }
  
  const showMessage = (text, type = 'success') => {
    // Usar el sistema global de notificaciones en lugar del mensaje local
    switch (type) {
      case 'success':
        showSuccess(text)
        break
      case 'error':
        showError(text)
        break
      case 'warning':
        showWarning(text)
        break
      case 'info':
      default:
        showInfo(text)
        break
    }
  }
  
  // Funciones de gesti√≥n del formulario
  const resetForm = (mapRadius, clearMap, createDefaultSchedule, formErrors, showDescriptionHint, showNameHint, form) => {
    // Resetear datos del formulario
    areaForm.value = {
      name: '',
      description: '',
      latitude: '',
      longitude: '',
      radius: 200,
      status: 'active'  // CR√çTICO: Incluir status por defecto
    }
    
    // Resetear variables de edici√≥n
    editingArea.value = null
    
    // Resetear mapa
    if (mapRadius) mapRadius.value = 10
    if (clearMap) clearMap()
    
    // Resetear horarios
    if (createDefaultSchedule) createDefaultSchedule()
    
    // Limpiar errores del formulario
    if (formErrors) {
      Object.keys(formErrors.value).forEach(key => {
        formErrors.value[key] = ''
      })
    }
    
    // Ocultar hints
    if (showDescriptionHint) showDescriptionHint.value = false
    if (showNameHint) showNameHint.value = false
    
    // Resetear validaci√≥n del formulario
    if (form && form.value) {
      form.value.resetValidation()
    }
    
    console.log('üìù Formulario reseteado')
  }
  
  const openNewAreaDialog = (resetForm, showDialog) => {
    console.log('üÜï Abriendo di√°logo para nueva √°rea')
    resetForm()
    showDialog.value = true
  }
  
  const cancelDialog = (showDialog, editingArea, resetForm) => {
    console.log('‚ùå Cancelando di√°logo')
    showDialog.value = false
    // Solo resetear si est√°bamos creando (no editando)
    if (!editingArea.value) {
      resetForm()
    }
  }
  
  const confirmDelete = async (areaToDelete, areas, showDeleteDialog, loadAreas) => {
    if (!areaToDelete.value) return
    
    deleting.value = true
    try {
      // Eliminar desde API
      await areaService.delete(areaToDelete.value.id)
      
      // Actualizar el estado del √°rea en lugar de removerla
      const index = areas.value.findIndex(area => area.id === areaToDelete.value.id)
      if (index !== -1) {
        areas.value[index].status = 'inactive'
      }
      
      showDeleteDialog.value = false
      areaToDelete.value = null
      
      showMessage('√Årea desactivada correctamente')
      console.log('√Årea eliminada exitosamente')
      
      // Recargar la lista para mostrar el cambio de estado
      await loadAreas()
    } catch (error) {
      console.error('Error eliminando √°rea:', error)
      // Mostrar mensaje de error al usuario
      alert('Error eliminando √°rea: ' + (error.response?.data?.message || error.message))
    } finally {
      deleting.value = false
    }
  }
  
  const saveArea = async (areaForm, scheduleType, schedule, validateSchedule, updateLocalArea, areas, sortAreasAlphabetically, loadAreas, resetForm, editingArea) => {
    console.log('üöÄ === INICIO DE SAVEAREA ===')
    console.log('üîç Iniciando saveArea...')
    console.log('üìù Datos del formulario:', areaForm.value)
    console.log('üîç scheduleType.value:', scheduleType.value)
    console.log('üîç schedule.value:', schedule.value)
    
    try {
      // Validaci√≥n b√°sica del formulario
      if (!areaForm.value.name || !areaForm.value.description || !areaForm.value.latitude || !areaForm.value.longitude || !areaForm.value.radius) {
        console.error('‚ùå Validaci√≥n del formulario fall√≥')
        showMessage('‚ö†Ô∏è Por favor, completa todos los campos obligatorios correctamente', 'warning')
        return
      }
      
      console.log('‚úÖ Validaci√≥n del formulario pas√≥')
      
      // La validaci√≥n de Vuetify se debe hacer en el componente padre antes de llamar a esta funci√≥n
      console.log('‚úÖ Validaci√≥n de Vuetify omitida (se debe hacer en el componente padre)')
      
      // ‚úÖ Validar horarios antes de continuar
      if (!validateSchedule()) {
        console.error('‚ùå Validaci√≥n de horarios fall√≥')
        return
      }
      
      console.log('‚úÖ Validaci√≥n de horarios pas√≥')
      
      console.log('üîç Antes de validaci√≥n de ubicaci√≥n...')
      console.log('üîç areaForm.value.latitude:', areaForm.value.latitude)
      console.log('üîç areaForm.value.longitude:', areaForm.value.longitude)
      
      // VALIDACI√ìN CR√çTICA: Verificar que se haya seleccionado una ubicaci√≥n
      if (!areaForm.value.latitude || !areaForm.value.longitude) {
        console.error('‚ùå No se ha seleccionado ubicaci√≥n en el mapa')
        alert('‚ö†Ô∏è Debes seleccionar una ubicaci√≥n en el mapa antes de guardar el √°rea.')
        return
      }
      
      console.log('‚úÖ Validaci√≥n de ubicaci√≥n pas√≥')
      
      // Validar que las coordenadas sean n√∫meros v√°lidos
      const lat = parseFloat(areaForm.value.latitude)
      const lng = parseFloat(areaForm.value.longitude)
      
      if (isNaN(lat) || isNaN(lng)) {
        console.error('‚ùå Coordenadas no son n√∫meros v√°lidos:', {
          latitude: areaForm.value.latitude,
          longitude: areaForm.value.longitude
        })
        alert('‚ö†Ô∏è Las coordenadas deben ser n√∫meros v√°lidos.')
        return
      }
      
      // Validar rangos de coordenadas
      if (lat < -90 || lat > 90) {
        console.error('‚ùå Latitud fuera de rango:', lat)
        alert('‚ö†Ô∏è La latitud debe estar entre -90 y 90 grados.')
        return
      }
      
      if (lng < -180 || lng > 180) {
        console.error('‚ùå Longitud fuera de rango:', lng)
        alert('‚ö†Ô∏è La longitud debe estar entre -180 y 180 grados.')
        return
      }

      // Verificar que el radio sea v√°lido
      if (!areaForm.value.radius || areaForm.value.radius < 10) {
        console.error('‚ùå Radio inv√°lido')
        alert('‚ö†Ô∏è El radio debe ser de al menos 10 metros.')
        return
      }
      
      // Validar que el radio sea un n√∫mero
      const radius = parseInt(areaForm.value.radius)
      if (isNaN(radius) || radius < 10 || radius > 10000) {
        console.error('‚ùå Radio fuera de rango:', radius)
        alert('‚ö†Ô∏è El radio debe estar entre 10 y 10000 metros.')
        return
      }
      
      saving.value = true
      
      // Preparar datos del √°rea con horarios
      const areaData = { ...areaForm.value }
      
      // Agregar horarios seg√∫n el tipo seleccionado
      if (scheduleType.value === 'default') {
        // ‚úÖ Horario por defecto - usar valores del formulario validados
        areaData.schedule = {
          schedule_type: 'default',
          monday_active: schedule.value.monday_active,
          monday_start: schedule.value.monday_start,
          monday_end: schedule.value.monday_end,
          tuesday_active: schedule.value.tuesday_active,
          tuesday_start: schedule.value.tuesday_start,
          tuesday_end: schedule.value.tuesday_end,
          wednesday_active: schedule.value.wednesday_active,
          wednesday_start: schedule.value.wednesday_start,
          wednesday_end: schedule.value.wednesday_end,
          thursday_active: schedule.value.thursday_active,
          thursday_start: schedule.value.thursday_start,
          thursday_end: schedule.value.thursday_end,
          friday_active: schedule.value.friday_active,
          friday_start: schedule.value.friday_start,
          friday_end: schedule.value.friday_end,
          saturday_active: schedule.value.saturday_active,
          saturday_start: schedule.value.saturday_start,
          saturday_end: schedule.value.saturday_end,
          sunday_active: schedule.value.sunday_active,
          sunday_start: schedule.value.sunday_start,
          sunday_end: schedule.value.sunday_end,
          grace_period_minutes: schedule.value.grace_period_minutes
        }
        console.log('‚úÖ Horario por defecto configurado desde formulario:', areaData.schedule)
      } else if (scheduleType.value === 'custom') {
        // ‚úÖ Horario personalizado - incluir todos los campos
        areaData.schedule = {
          schedule_type: 'custom',
          monday_active: schedule.value.monday_active,
          monday_start: schedule.value.monday_start,
          monday_end: schedule.value.monday_end,
          tuesday_active: schedule.value.tuesday_active,
          tuesday_start: schedule.value.tuesday_start,
          tuesday_end: schedule.value.tuesday_end,
          wednesday_active: schedule.value.wednesday_active,
          wednesday_start: schedule.value.wednesday_start,
          wednesday_end: schedule.value.wednesday_end,
          thursday_active: schedule.value.thursday_active,
          thursday_start: schedule.value.thursday_start,
          thursday_end: schedule.value.thursday_end,
          friday_active: schedule.value.friday_active,
          friday_start: schedule.value.friday_start,
          friday_end: schedule.value.friday_end,
          saturday_active: schedule.value.saturday_active,
          saturday_start: schedule.value.saturday_start,
          saturday_end: schedule.value.saturday_end,
          sunday_active: schedule.value.sunday_active,
          sunday_start: schedule.value.sunday_start,
          sunday_end: schedule.value.sunday_end,
          grace_period_minutes: schedule.value.grace_period_minutes
        }
        console.log('‚úÖ Horario personalizado configurado:', areaData.schedule)
      } else {
        // ‚úÖ Sin horario
        areaData.schedule = {
          schedule_type: 'none'
        }
        console.log('‚úÖ Sin horario configurado')
      }
      
      console.log('üì§ Datos del √°rea con horarios:', areaData)
      
      if (editingArea.value) {
        console.log('üîÑ === ACTUALIZANDO √ÅREA EXISTENTE ===')
        console.log('üîç ID del √°rea a editar:', editingArea.value.id)
        
        // Actualizar √°rea existente
        const updatedArea = await areaService.update(editingArea.value.id, areaData)
        console.log('üì• Respuesta del backend (update):', updatedArea)
        
        // ‚úÖ ACTUALIZAR INMEDIATAMENTE el √°rea en la lista local
        updateLocalArea(updatedArea)
        
        // Cerrar modal y resetear formulario
        showDialog.value = false
        resetForm()
        
        showSuccess('‚úÖ √Årea actualizada correctamente')
        console.log('‚úÖ √Årea actualizada exitosamente')
      } else {
        console.log('üÜï Creando nueva √°rea...')
        console.log('üì§ Datos enviados al servicio:', areaData)
        
        // Crear nueva √°rea
        const newArea = await areaService.create(areaData)
        console.log('üì• Respuesta del backend (create):', newArea)
        
        // Agregar nueva √°rea a la lista
        areas.value.push({ ...newArea })
        
        // Reordenar la lista alfab√©ticamente despu√©s de agregar
        areas.value = sortAreasAlphabetically([...areas.value])
        
        console.log('‚úÖ √Årea creada y lista reordenada alfab√©ticamente')
        console.log('üìã Nuevo orden:', areas.value.map(area => area.name))
      }
      
      // CR√çTICO: Guardar ID del √°rea editada antes de resetear
      const editedAreaId = editingArea.value?.id
      
      showDialog.value = false
      
      // ‚úÖ Recargar √°reas solo si es necesario (despu√©s de un breve delay para asegurar sincronizaci√≥n)
      setTimeout(async () => {
        try {
          console.log('üîÑ Recargando √°reas para sincronizaci√≥n...')
          await loadAreas()
          console.log('‚úÖ √Åreas recargadas para sincronizaci√≥n')
        } catch (error) {
          console.error('‚ùå Error recargando √°reas:', error)
        }
      }, 500)
      
      // Si acabamos de editar un √°rea, verificar que los datos se guardaron correctamente
      if (editedAreaId) {
        try {
          console.log('üîÑ Verificando datos guardados del √°rea editada ID:', editedAreaId)
          const freshAreaData = await areaService.getById(editedAreaId)
          console.log('üìä Datos frescos del √°rea despu√©s de guardar:', freshAreaData)
          
          // Verificar que las coordenadas se guardaron correctamente
          if (freshAreaData.latitude && freshAreaData.longitude) {
            console.log('‚úÖ Coordenadas verificadas en BD:', {
              latitude: freshAreaData.latitude,
              longitude: freshAreaData.longitude,
              radius: freshAreaData.radius
            })
          } else {
            console.warn('‚ö†Ô∏è Las coordenadas no se guardaron correctamente en la BD')
          }
        } catch (error) {
          console.error('‚ùå Error verificando datos guardados:', error)
        }
      }
      
      // Resetear formulario DESPU√âS de verificar
      resetForm()
      
      console.log('üéâ Proceso completado exitosamente')
    } catch (error) {
      console.error('‚ùå Error guardando √°rea:', error)
      console.error('üìä Detalles del error:', {
        message: error.message,
        response: error.response?.data,
        status: error.response?.status,
        statusText: error.response?.statusText
      })
      
      // Mostrar mensaje de error al usuario
      alert('Error guardando √°rea: ' + (error.response?.data?.message || error.message))
    } finally {
      saving.value = false
    }
  }
  
  return {
    showDialog,
    saving,
    editingArea,
    areaToDelete,
    showDeleteDialog,
    deleting,
    areaForm,
    formatCoordinate,
    showMessage,
    resetForm,
    openNewAreaDialog,
    cancelDialog,
    confirmDelete,
    saveArea
  }
}
